{% extends "base.html" %}

{% block title %}Forgot Password - parKING{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forgot_password.css') }}">
{% endblock %}

{% block content %}
<div class="forgot-page-container">
    <div class="forgot-card">
        <div class="forgot-header">
            <h1>Reset Lozinke</h1>
            <p>Verifikujte vaš nalog u <span class="forgot-brand-text">parKING</span> sistemu</p>
        </div>

        <form id="verifyForm" class="forgot-form">
            <div class="forgot-group">
                <label for="email">Email Adresa</label>
                <input type="email" id="email" name="email" required placeholder="primer@email.com">
            </div>
            <div class="forgot-group">
                <label for="phone">Broj Telefona</label>
                <input type="tel" id="phone" name="phone" required placeholder="+38267123456">
            </div>
            <button type="submit" class="forgot-btn-submit">
                <span>Verifikuj nalog</span>
            </button>
        </form>

        <form id="resetForm" class="forgot-form" style="display:none;">
            <div class="forgot-group">
                <label for="new_password">Nova Lozinka</label>
                <input type="password" id="new_password" name="new_password" required placeholder="Unesite novu lozinku">
            </div>
            <div class="forgot-group">
                <label for="reenter_password">Ponovite Lozinku</label>
                <input type="password" id="reenter_password" name="reenter_password" required placeholder="Ponovite lozinku">
            </div>
            <button type="submit" class="forgot-btn-reset">
                <span>Promijeni lozinku</span>
            </button>
        </form>

        <div class="forgot-footer-links">
            <a href="/login" class="forgot-link-back">Nazad na prijavu</a>
        </div>
    </div>
</div>

<script>
const verifyForm = document.getElementById("verifyForm");
const resetForm = document.getElementById("resetForm");

let verifiedEmail = "";
let verifiedPhone = "";

verifyForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!email || !phone) {
        alert("Sva polja su obavezna!");
        return;
    }
    if (!email.includes("@") || !email.includes(".")) {
        alert("Email mora sadržati '@' i '.'");
        return;
    }
    if (!phone.startsWith("+")) {
        alert("Broj telefona mora početi sa '+'");
        return;
    }

    try {
        const res = await fetch("/api/users/verify-forgot-password", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({email, phone})
        });
        const result = await res.json();
        if (res.ok) {
            alert(result.message);
            verifiedEmail = email;
            verifiedPhone = phone;
            verifyForm.style.display = "none";
            resetForm.style.display = "flex"; 
        } else {
            alert(result.error || "Verifikacija nije uspjela.");
        }
    } catch (err) {
        console.error(err);
        alert("Došlo je do greške prilikom verifikacije.");
    }
});

resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById("new_password").value;
    const reenterPassword = document.getElementById("reenter_password").value;

    if (!newPassword || !reenterPassword) {
        alert("Sva polja su obavezna!");
        return;
    }
    if (newPassword !== reenterPassword) {
        alert("Lozinke se ne poklapaju!");
        return;
    }

    try {
        const res = await fetch("/api/users/change-password", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({email: verifiedEmail, phone: verifiedPhone, new_password: newPassword})
        });
        const result = await res.json();
        if (res.ok) {
            alert("Password uspješno promijenjen! Možete se loginovati.");
            window.location.href = "/login";
        } else {
            alert(result.error || "Promjena passworda nije uspjela.");
        }
    } catch (err) {
        console.error(err);
        alert("Došlo je do greške prilikom promjene passworda.");
    }
});
</script>
{% endblock %}